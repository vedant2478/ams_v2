#:import datetime datetime.datetime

<RegisterUserScreen>:
    name: "register_user"

    canvas.before:
        Color:
            rgba: 0.05, 0.08, 0.12, 1
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: "vertical"
        spacing: 0

        # ===== Header =====
        BoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: "60dp"
            padding: "15dp", "10dp"
            spacing: "10dp"
            
            canvas.before:
                Color:
                    rgba: 0.08, 0.12, 0.18, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: 0.2, 0.4, 0.6, 0.3
                Rectangle:
                    pos: self.x, self.y
                    size: self.width, 2
            
            Button:
                text: "‚Üê Back"
                size_hint_x: None
                width: "90dp"
                background_normal: ""
                background_color: 0.15, 0.25, 0.35, 0.8
                color: 0.85, 0.95, 1, 1
                font_size: "15sp"
                bold: True
                on_release: root.go_back()
            
            Label:
                text: "Register New User"
                size_hint_x: 0.6
                font_size: "18sp"
                bold: True
                color: 0.9, 0.95, 1, 1
                halign: "center"
                valign: "middle"
            
            Label:
                text: datetime.now().strftime('%H:%M')
                size_hint_x: None
                width: "70dp"
                font_size: "16sp"
                bold: True
                color: 0.85, 0.95, 1, 1
                halign: "right"
                valign: "middle"

        # ===== Main Content =====
        BoxLayout:
            orientation: "vertical"
            spacing: "10dp"
            padding: "15dp"

            # ===== Status Message =====
            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: "50dp"
                spacing: "5dp"
                
                canvas.before:
                    Color:
                        rgba: 0.1, 0.15, 0.22, 0.8
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [10]
                
                Label:
                    id: status_label
                    text: root.status_message
                    font_size: "15sp"
                    bold: True
                    color: 0.7, 0.9, 1, 1
                    halign: "center"
                    valign: "middle"
                    text_size: self.size
                    padding: "10dp", "5dp"

            # ===== Camera Feed =====
            BoxLayout:
                orientation: "vertical"
                size_hint_y: 0.35
                spacing: "8dp"

                Label:
                    text: "üìπ Position Your Face"
                    size_hint_y: None
                    height: "30dp"
                    font_size: "14sp"
                    bold: True
                    color: 0.7, 0.85, 1, 1
                    halign: "center"
                    valign: "middle"

                FloatLayout:
                    canvas.before:
                        Color:
                            rgba: 0.12, 0.20, 0.28, 0.95
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [15]
                        Color:
                            rgba: 0.2, 0.5, 0.8, 0.6
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, 15)
                            width: 2

                    KivyCamera:
                        id: camera_feed
                        size_hint: 0.95, 0.95
                        pos_hint: {"center_x": 0.5, "center_y": 0.5}
                        allow_stretch: True
                        keep_ratio: True
                        
                        canvas.before:
                            Color:
                                rgba: 0.08, 0.12, 0.18, 1
                            RoundedRectangle:
                                pos: self.pos
                                size: self.size
                                radius: [12]

            # ===== Employee Code Input =====
            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: "80dp"
                spacing: "6dp"

                Label:
                    text: "üÜî Employee Code:"
                    size_hint_y: None
                    height: "25dp"
                    font_size: "13sp"
                    bold: True
                    color: 0.8, 0.9, 1, 1
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                    padding: "5dp", 0

                TextInput:
                    id: name_input
                    text: root.username
                    hint_text: "Enter employee code using keypad below"
                    multiline: False
                    readonly: True      # we use custom keypad
                    size_hint_y: None
                    height: "50dp"
                    font_size: "18sp"
                    background_color: 0, 0, 0, 0
                    foreground_color: 0.9, 0.95, 1, 1
                    cursor_color: 0.3, 0.6, 0.9, 1
                    padding: "15dp", "12dp"
                    on_text: root.on_text_change()
                    
                    canvas.before:
                        Color:
                            rgba: 0.12, 0.18, 0.25, 1
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [12]
                        Color:
                            rgba: 0.25, 0.45, 0.65, 0.5
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, 12)
                            width: 1.5

            # ===== Capture Button =====
            Button:
                id: capture_btn
                text: f"üì∏ Capture Sample ({root.sample_count}/{root.target_samples})"
                size_hint_y: None
                height: "55dp"
                disabled: True
                background_normal: ""
                background_color: 0, 0, 0, 0
                color: 1, 1, 1, 1
                font_size: "18sp"
                bold: True
                on_release: root.on_capture()
                
                canvas.before:
                    Color:
                        rgba: (0.15, 0.65, 0.35, 1) if not self.disabled else (0.3, 0.3, 0.3, 0.5)
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [14]
                    Color:
                        rgba: (0.2, 0.8, 0.5, 0.8) if not self.disabled else (0, 0, 0, 0)
                    Line:
                        rounded_rectangle: (self.x, self.y, self.width, self.height, 14)
                        width: 2

            # ===== NUMERIC TOUCH KEYPAD =====
            BoxLayout:
                orientation: "vertical"
                size_hint_y: 0.42
                spacing: "4dp"
                padding: "8dp"
                
                canvas.before:
                    Color:
                        rgba: 0.08, 0.12, 0.18, 0.95
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [12]
                
                # Row 1: 1-3
                BoxLayout:
                    spacing: "4dp"
                    size_hint_y: None
                    height: "45dp"
                    
                    Button:
                        text: "1"
                        font_size: "18sp"
                        bold: True
                        background_normal: ""
                        background_color: 0.15, 0.30, 0.45, 0.95
                        color: 0.9, 0.95, 1, 1
                        on_release: root.on_key_press('1')
                    
                    Button:
                        text: "2"
                        font_size: "18sp"
                        bold: True
                        background_normal: ""
                        background_color: 0.15, 0.30, 0.45, 0.95
                        color: 0.9, 0.95, 1, 1
                        on_release: root.on_key_press('2')
                    
                    Button:
                        text: "3"
                        font_size: "18sp"
                        bold: True
                        background_normal: ""
                        background_color: 0.15, 0.30, 0.45, 0.95
                        color: 0.9, 0.95, 1, 1
                        on_release: root.on_key_press('3')

                # Row 2: 4-6
                BoxLayout:
                    spacing: "4dp"
                    size_hint_y: None
                    height: "45dp"
                    
                    Button:
                        text: "4"
                        font_size: "18sp"
                        bold: True
                        background_normal: ""
                        background_color: 0.15, 0.30, 0.45, 0.95
                        color: 0.9, 0.95, 1, 1
                        on_release: root.on_key_press('4')
                    
                    Button:
                        text: "5"
                        font_size: "18sp"
                        bold: True
                        background_normal: ""
                        background_color: 0.15, 0.30, 0.45, 0.95
                        color: 0.9, 0.95, 1, 1
                        on_release: root.on_key_press('5')
                    
                    Button:
                        text: "6"
                        font_size: "18sp"
                        bold: True
                        background_normal: ""
                        background_color: 0.15, 0.30, 0.45, 0.95
                        color: 0.9, 0.95, 1, 1
                        on_release: root.on_key_press('6')

                # Row 3: 7-9
                BoxLayout:
                    spacing: "4dp"
                    size_hint_y: None
                    height: "45dp"
                    
                    Button:
                        text: "7"
                        font_size: "18sp"
                        bold: True
                        background_normal: ""
                        background_color: 0.15, 0.30, 0.45, 0.95
                        color: 0.9, 0.95, 1, 1
                        on_release: root.on_key_press('7')
                    
                    Button:
                        text: "8"
                        font_size: "18sp"
                        bold: True
                        background_normal: ""
                        background_color: 0.15, 0.30, 0.45, 0.95
                        color: 0.9, 0.95, 1, 1
                        on_release: root.on_key_press('8')
                    
                    Button:
                        text: "9"
                        font_size: "18sp"
                        bold: True
                        background_normal: ""
                        background_color: 0.15, 0.30, 0.45, 0.95
                        color: 0.9, 0.95, 1, 1
                        on_release: root.on_key_press('9')

                # Row 4: 0 + Backspace + Clear
                BoxLayout:
                    spacing: "4dp"
                    size_hint_y: None
                    height: "45dp"
                    
                    Button:
                        text: "0"
                        font_size: "18sp"
                        bold: True
                        background_normal: ""
                        background_color: 0.15, 0.30, 0.45, 0.95
                        color: 0.9, 0.95, 1, 1
                        on_release: root.on_key_press('0')
                    
                    Button:
                        text: "‚å´"
                        font_size: "20sp"
                        bold: True
                        background_normal: ""
                        background_color: 0.5, 0.2, 0.2, 0.9
                        color: 1, 1, 1, 1
                        on_release: root.on_key_press('‚å´')
                    
                    Button:
                        text: "CLEAR"
                        font_size: "16sp"
                        bold: True
                        background_normal: ""
                        background_color: 0.5, 0.2, 0.2, 0.9
                        color: 1, 1, 1, 1
                        on_release: root.clear_text()
