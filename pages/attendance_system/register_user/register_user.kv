#:import datetime datetime.datetime

<RegisterUserScreen>:
    name: "register_user"

    canvas.before:
        # Background
        Color:
            rgba: 0.05, 0.08, 0.12, 1
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: "vertical"
        spacing: 0

        # ===== Header =====
        BoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: "60dp"
            padding: "15dp", "10dp"
            spacing: "10dp"
            
            canvas.before:
                Color:
                    rgba: 0.08, 0.12, 0.18, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: 0.2, 0.4, 0.6, 0.3
                Rectangle:
                    pos: self.x, self.y
                    size: self.width, 2
            
            Button:
                text: "‚Üê Back"
                size_hint_x: None
                width: "90dp"
                background_normal: ""
                background_color: 0.15, 0.25, 0.35, 0.8
                color: 0.85, 0.95, 1, 1
                font_size: "15sp"
                bold: True
                on_release: root.go_back()
            
            Label:
                text: "Register New User"
                size_hint_x: 0.6
                font_size: "18sp"
                bold: True
                color: 0.9, 0.95, 1, 1
                halign: "center"
                valign: "middle"
            
            Label:
                text: datetime.now().strftime('%H:%M')
                size_hint_x: None
                width: "70dp"
                font_size: "16sp"
                bold: True
                color: 0.85, 0.95, 1, 1
                halign: "right"
                valign: "middle"

        # ===== Main Content =====
        BoxLayout:
            orientation: "vertical"
            spacing: "8dp"
            padding: "12dp", "8dp"

            # ===== Status Message =====
            Label:
                id: status_label
                text: root.status_message
                size_hint_y: None
                height: "28dp"
                font_size: "14sp"
                color: 0.7, 0.9, 1, 1
                halign: "center"
                valign: "middle"

            # ===== Camera Feed =====
            BoxLayout:
                orientation: "vertical"
                size_hint_y: 0.22
                spacing: "5dp"

                Label:
                    text: "üìπ Position Your Face"
                    size_hint_y: None
                    height: "22dp"
                    font_size: "13sp"
                    bold: True
                    color: 0.7, 0.85, 1, 1

                FloatLayout:
                    canvas.before:
                        Color:
                            rgba: 0.12, 0.20, 0.28, 0.95
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [15]

                    KivyCamera:
                        id: camera_feed
                        size_hint: 0.96, 0.96
                        pos_hint: {"center_x": 0.5, "center_y": 0.5}
                        
                        canvas.before:
                            Color:
                                rgba: 0.08, 0.12, 0.18, 1
                            RoundedRectangle:
                                pos: self.pos
                                size: self.size
                                radius: [12]

            # ===== Name Input =====
            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: "65dp"
                spacing: "4dp"

                Label:
                    text: "Enter User Name:"
                    size_hint_y: None
                    height: "18dp"
                    font_size: "12sp"
                    color: 0.8, 0.9, 1, 1
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                    padding: "5dp", 0

                TextInput:
                    id: name_input
                    hint_text: "Type name here..."
                    multiline: False
                    size_hint_y: None
                    height: "43dp"
                    font_size: "17sp"
                    background_color: 0.12, 0.18, 0.25, 1
                    foreground_color: 0.9, 0.95, 1, 1
                    cursor_color: 0.2, 0.5, 0.8, 1
                    padding: "12dp", "10dp"
                    on_text: root.on_text_change(self, self.text)
                    
                    canvas.before:
                        Color:
                            rgba: 0.12, 0.18, 0.25, 1
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]
                        Color:
                            rgba: 0.25, 0.45, 0.65, 0.4
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, 10)
                            width: 1.2

            # ===== Capture Button =====
            Button:
                id: capture_btn
                text: f"üì∏ Capture ({root.sample_count}/{root.target_samples})"
                size_hint_y: None
                height: "48dp"
                disabled: True
                background_normal: ""
                background_color: 0, 0, 0, 0
                color: 1, 1, 1, 1
                font_size: "17sp"
                bold: True
                on_release: root.on_capture()
                
                canvas.before:
                    Color:
                        rgba: (0.15, 0.55, 0.35, 1) if not self.disabled else (0.3, 0.3, 0.3, 0.5)
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [12]

            # ===== Virtual Keyboard (NOW VISIBLE) =====
            VKeyboard:
                id: vkeyboard
                size_hint_y: 0.42
                layout: 'qwerty'
                target: name_input
                
                canvas.before:
                    Color:
                        rgba: 0.10, 0.15, 0.22, 0.98
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [12]
